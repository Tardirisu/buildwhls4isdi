name: Build ARMv6 Wheels

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # 匹配树莓派 Debian Bookworm 的默认版本

      - name: Collect ARMv6 Wheels from piwheels
        run: |
          mkdir -p wheelhouse
          
          # 核心逻辑：
          # 1. --platform linux_armv6l: 强制要求树莓派1/Zero架构
          # 2. --only-binary=:all:: 拒绝源码包，只要编译好的二进制
          # 3. --extra-index-url: 指向树莓派专用仓库
          python -m pip download \
            --platform linux_armv6l \
            --only-binary=:all: \
            --python-version 311 \
            --implementation cp \
            --abi cp311 \
            --dest wheelhouse \
            -r requirements.txt \
            --extra-index-url https://www.piwheels.org/simple
          
          # 检查是否成功下载了 cryptography 等大件
          ls -lh wheelhouse

      - name: Upload Wheels as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: armv6-wheels
          path: wheelhouse/
